stages:
  - build
  - deploy

before_script:
  #  - echo "Building git branch "${CI_COMMIT_REF_NAME}" at commit "${CI_COMMIT_SHA}""
  #  - Remove-Item -Recurse -Force D:\radex -ErrorAction Ignore

building:
  stage: build
  variables:
   GET_SOURCES_ATTEMPTS: "3"
   GIT_STRATEGY: clone
   SHORT_SHA: ${CI_COMMIT_SHA:0:8}
  script:
   - echo "Building git branch "${CI_COMMIT_REF_NAME}" at commit "${CI_COMMIT_SHA}" "${SHORT_SHA}""
   - automated_build/msbuild_vsprojects.bat -no-pause
  artifacts:
   when: always
   expire_in: 1 month
   name: "${CI_COMMIT_REF_SLUG}_${CI_COMMIT_SHA}"
   paths:
    - bin/*
    - automated_build/log/*

deploying:
  stage: deploy
  when: on_success
  variables:
   GIT_STRATEGY: none
   TARGETPATH: C:\Users\mouvent\RADEX AG\RX-Project - Documents
  script:
   - $DATESTR=get-date -format "yyyyMMdd-HHmm"
   - if (${CI_COMMIT_TAG} -And ${CI_COMMIT_TAG}[0] -eq 'v')
     {
       $COMMIT_TYPE='release\' + ${CI_COMMIT_TAG}
     }
     elseif ($BUILDNAME -eq "nightly")
     {
       $COMMIT_TYPE='nightly-builds\' + ${DATESTR} + '_' + ${CI_COMMIT_REF_SLUG} + '_' + ${CI_COMMIT_SHA}
     }
     else
     {
       $COMMIT_TYPE='commits\' + ${DATESTR} + '_' + ${CI_COMMIT_REF_SLUG} + '_' + ${CI_COMMIT_SHA}
     }
   - echo "deploying bin to ${TARGETPATH}\${COMMIT_TYPE}\bin"
   - xcopy /E /Y /F bin ${TARGETPATH}\${COMMIT_TYPE}\bin\
