/******************************************************************************/
/** \file adc_thermistor.c
 **
 ** read the thermistor value of the heater board
 **
 **	Copyright 2016 by radex AG, Switzerland. All rights reserved.
 **	Written by Stefan Weber
 **
 ******************************************************************************/

/******************************************************************************/
/* Include files                                                              */
/******************************************************************************/

#include "rx_ink_common.h"
#include "adc_thermistor.h"


typedef struct
{
	alt_u32 x;
	alt_u32 y;
}dsp_lookup_f_t;

dsp_lookup_f_t my_table[]=
{
{ .x=	834	,	.y=	10000	},
//{ .x=	826	,	.y=	11000	},
{ .x=	818	,	.y=	12000	},
//{ .x=	809	,	.y=	13000	},
{ .x=	801	,	.y=	14000	},
//{ .x=	792	,	.y=	15000	},
{ .x=	783	,	.y=	16000	},
//{ .x=	774	,	.y=	17000	},
{ .x=	765	,	.y=	18000	},
//{ .x=	755	,	.y=	19000	},
{ .x=	746	,	.y=	20000	},
//{ .x=	736	,	.y=	21000	},
{ .x=	726	,	.y=	22000	},
//{ .x=	716	,	.y=	23000	},
{ .x=	706	,	.y=	24000	},
//{ .x=	695	,	.y=	25000	},
{ .x=	685	,	.y=	26000	},
//{ .x=	674	,	.y=	27000	},
{ .x=	664	,	.y=	28000	},
//{ .x=	653	,	.y=	29000	},
{ .x=	642	,	.y=	30000	},
//{ .x=	631	,	.y=	31000	},
{ .x=	620	,	.y=	32000	},
//{ .x=	609	,	.y=	33000	},
{ .x=	598	,	.y=	34000	},
//{ .x=	587	,	.y=	35000	},
{ .x=	576	,	.y=	36000	},
//{ .x=	565	,	.y=	37000	},
{ .x=	554	,	.y=	38000	},
//{ .x=	543	,	.y=	39000	},
{ .x=	532	,	.y=	40000	},
//{ .x=	521	,	.y=	41000	},
{ .x=	510	,	.y=	42000	},
//{ .x=	499	,	.y=	43000	},
{ .x=	489	,	.y=	44000	},
//{ .x=	478	,	.y=	45000	},
{ .x=	467	,	.y=	46000	},
//{ .x=	457	,	.y=	47000	},
{ .x=	446	,	.y=	48000	},
//{ .x=	436	,	.y=	49000	},
{ .x=	426	,	.y=	50000	},
//{ .x=	416	,	.y=	51000	},
{ .x=	405	,	.y=	52000	},
//{ .x=	396	,	.y=	53000	},
{ .x=	386	,	.y=	54000	},
//{ .x=	377	,	.y=	55000	},
{ .x=	368	,	.y=	56000	},
//{ .x=	358	,	.y=	57000	},
{ .x=	349	,	.y=	58000	},
//{ .x=	340	,	.y=	59000	},
{ .x=	332	,	.y=	60000	},
//{ .x=	323	,	.y=	61000	},
{ .x=	315	,	.y=	62000	},
//{ .x=	306	,	.y=	63000	},
{ .x=	298	,	.y=	64000	},
//{ .x=	290	,	.y=	65000	},
{ .x=	283	,	.y=	66000	},
//{ .x=	275	,	.y=	67000	},
{ .x=	268	,	.y=	68000	},
//{ .x=	260	,	.y=	69000	},
{ .x=	253	,	.y=	70000	},
//{ .x=	246	,	.y=	71000	},
{ .x=	240	,	.y=	72000	},
//{ .x=	233	,	.y=	73000	},
{ .x=	227	,	.y=	74000	},
//{ .x=	220	,	.y=	75000	},
{ .x=	214	,	.y=	76000	},
//{ .x=	208	,	.y=	77000	},
{ .x=	202	,	.y=	78000	},
//{ .x=	197	,	.y=	79000	},
{ .x=	191	,	.y=	80000	},
//{ .x=	186	,	.y=	81000	},
{ .x=	181	,	.y=	82000	},
//{ .x=	176	,	.y=	83000	},
{ .x=	171	,	.y=	84000	},
//{ .x=	166	,	.y=	85000	},
{ .x=	161	,	.y=	86000	},
//{ .x=	157	,	.y=	87000	},
{ .x=	152	,	.y=	88000	},
//{ .x=	148	,	.y=	89000	},
{ .x=	144	,	.y=	90000	},
//{ .x=	140	,	.y=	91000	},
{ .x=	136	,	.y=	92000	},
//{ .x=	132	,	.y=	93000	},
{ .x=	128	,	.y=	94000	},
//{ .x=	124	,	.y=	95000	},
{ .x=	121	,	.y=	96000	},
//{ .x=	118	,	.y=	97000	},
{ .x=	114	,	.y=	98000	},
//{ .x=	111	,	.y=	99000	},
{ .x=	108	,	.y=	100000	},
//{ .x=	105	,	.y=	101000	},
{ .x=	102	,	.y=	102000	},
//{ .x=	99	,	.y=	103000	},
{ .x=	96	,	.y=	104000	},
//{ .x=	94	,	.y=	105000	},
{ .x=	91	,	.y=	106000	},
//{ .x=	89	,	.y=	107000	},
{ .x=	86	,	.y=	108000	},
//{ .x=	84	,	.y=	109000	},
{ .x=	81	,	.y=	110000	},
//{ .x=	79	,	.y=	111000	},
{ .x=	77	,	.y=	112000	},
//{ .x=	75	,	.y=	113000	},
{ .x=	73	,	.y=	114000	},
//{ .x=	71	,	.y=	115000	},
{ .x=	69	,	.y=	116000	},
//{ .x=	67	,	.y=	117000	},
{ .x=	65	,	.y=	118000	},
//{ .x=	63	,	.y=	119000	},
{ .x=	62	,	.y=	120000	},
//{ .x=	60	,	.y=	121000	},
{ .x=	58	,	.y=	122000	},
//{ .x=	57	,	.y=	123000	},
{ .x=	55	,	.y=	124000	},
//{ .x=	54	,	.y=	125000	},
{ .x=	52	,	.y=	126000	},
//{ .x=	51	,	.y=	127000	},
{ .x=	50	,	.y=	128000	},
//{ .x=	48	,	.y=	129000	},
};

static alt_u32 _dsp_lookup_f(const dsp_lookup_f_t * table, alt_u32 x, alt_u32 min_y, alt_u32 max_y);

/**
 ******************************************************************************
 ** \brief  ADC0 single conversion start
 **
 ** \return  uint32_t   ADC result
 ******************************************************************************/
alt_u32 Main_adc_polling(alt_u32 value)
{
	int result=0;
	int tableSize=SIZEOF(my_table);

	result=_dsp_lookup_f(my_table, value, 0, tableSize-1);
	if((result==my_table[0].y)||(result==my_table[tableSize-1].y))
	{
		return INVALID_VALUE;
	}
	else
	{
		return result;
	}
}

/**
 ******************************************************************************
 ** \brief  thermistor lookup table
 **
 ** \return  uint32_t   ADC result
 ******************************************************************************/
static alt_u32 _dsp_lookup_f(const dsp_lookup_f_t * table, alt_u32 x, alt_u32 min_y, alt_u32 max_y)
{
	alt_u32 i=0;
	alt_u32 m, delta_x, delta_y;

	for(i=min_y; (x<table[i].x)&&(i<max_y);)			//find the two points in the table to use
	{
		i++;
	}
	if ( i >= max_y )									//make sure the point isn't past the end of the table
	{
		return table[max_y].y;
	}

	if ( i <= min_y )									//make sure the point isn't before the beginning of the table
	{
		return table[min_y].y;
	}

	delta_x =table[i-1].x - table[i].x;
	delta_y =table[i].y - table[i-1].y;
	if (delta_x==0) return INVALID_VALUE;
	m= (delta_y/delta_x);
	m=table[i-1].y-(x - table[i-1].x)*m;
	if(m>table[max_y].y)
	{
		m=table[max_y].y;
	}
	return m;
	// y = y0 + (x - x0) * ((y1 - y0)/(x1-x0)) where x0, x1 are nearest values of input x
  // y0, y1 are nearest values to output y
}
