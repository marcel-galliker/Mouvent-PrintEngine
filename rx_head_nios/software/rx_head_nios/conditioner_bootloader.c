/*
 * conditioner_bootloader.c
 *
 *  Created on: 01.02.2016
 *      Author: stefan
 */

#include "system.h"
#include <stdio.h>
#include <unistd.h>
#include "alt_types.h"
#include "sys/alt_irq.h"
#include "altera_avalon_timer.h"
#include "altera_avalon_timer_regs.h"
#include "altera_avalon_pio_regs.h"
#include "sys/alt_stdio.h"
#include "system.h"
#include "io.h"
#include "sys/alt_alarm.h"
#include "timer.h"
#include "trprintf.h"
#include "altera_avalon_uart.h"
#include "altera_avalon_uart_fd.h"
#include "altera_avalon_uart_regs.h"
#include "rx_ink_common.h"
#include "nios_def_head.h"
#include "uart.h"
#include "main.h"
#include "conditioner_bootloader.h"
#include "crc_calc.h"


//--- GPIO Pins ------------------------
#define MCU_RESET			0b0001
#define MCU_BOOT			0b0010
#define MCU_BOOTLOADER		0b0100
#define MCU_RESERVE			0b1000

#define  FLASH_BLK_SIZE		512

#define FOR_ALL_COND	for(i=0; i<MAX_HEADS_BOARD; i++)
#define FOR_ALL_ACTIVE_COND	for(i=0; i<MAX_HEADS_BOARD; i++) if (*pCondNo & (1<<i))

// #define TRACE

//Prototype

//  cond0_reserve       <= cond0_pio(3);
//  cond0_oe_bootloader <= cond0_pio(2);
//  cond0_boot_uc       <= cond0_pio(1);
//  cond0_reset_uc      <= cond0_pio(0);

//reset value 0x00000001 => reset =1;

//The communication baud rate is 9600[bps] when built-in high-speed CR oscillator is used
//External Osc. Source Oscillating Frequency 4MHz , Communication Baud Rate 9600bps
//=> 9600 bit per second => 50kb binary ~ 53'248 Bytes => 425'984 bit = 45s Programmierung !
// 115200 bit/sec => 4s programmierung => external 48MHz Quarz notwendig!

// oe_bootloader = 1;
// Boot_uC = 1;

//optimiert level 3 = 40'960 Bytes = 327'680 bit => 34s@9600 => 3s@115200
//optimiert level 3 & microlib = 36'864 Bytes = 294'912 bit => 31s@9600 => 3s@115200
//optimiert level 3 & microlib & cross module optimation =20'480 Bytes = 163840 bit => 17s@9600 => 1.5s@115200
//optimiert level 0 = 53'248 Bytes = 425'984 bit => 45s@9600 => 4s@115200


// danach RESET =1;

#pragma pack(1)

typedef struct
{
	UCHAR   cmd;
	UINT32 addr;
} SFlashCmd;

typedef struct
{
	UCHAR data[FLASH_BLK_SIZE];
	UCHAR crc_high;
	UCHAR crc_low;
} SFlashData;
#pragma pack()

typedef struct
{
	int 	   pos;
	SFlashData data;
} SConditionerData;

UCHAR ram_kernel_prepare []={0x00, 0x00, 0xe9, 0x03, 0x20, 0x20, 0x08, 0x00, 0x00, 0x34};
UCHAR ram_kernel[]={0x00,0xF0,0x00,0xB8,0x00,0xE0,0x00,0x01,0x4F,0xF2,0x00,0x20,0xC2,0xF2,0x03,0x00,0x40,0xF2,0x00,0x01,0xC2,0xF2,0x04,0x01,0x4F,0xEA,0x01,0x0D,0x31,0x21,0x00,0xF0,0x95,0xFB,0x4E,0xF6,0x07,0x12,0xC2,0xF2,0x03,0x02,0x11,0x78,0x00,0x22,0x4A,0x40,0x72,0xB1,0x01,0x22,0x4A,0x40,0x72,0xB1,0x02,0x22,0x4A,0x40,0x72,0xB1,0x03,0x22,0x4A,0x40,0x72,0xB1,0x04,0x22,0x4A,0x40,0x72,0xB1,0x05,0x22,0x4A,0x40,0x72,0xB1,0x09,0x25,0x05,0x26,0x0C,0xE0,0x09,0x25,0x05,0x26,0x45,0xE0,0x09,0x25,0x02,0x26,0x42,0xE0,0x19,0x25,0x02,0x26,0x3F,0xE0,0x29,0x25,0x02,0x26,0x3C,0xE0,0x76,0xE0,0x40,0xF2,0x38,0x07,0xC4,0xF2,0x01,0x07,0x3D,0x70,0x40,0xF2,0x3C,0x07,0xC4,0xF2,0x01,0x07,0x3E,0x70,0x40,0xF2,0x34,0x07,0xC4,0xF2,0x01,0x07,0x17,0x25,0x3D,0x70,0x40,0xF2,0x00,0x07,0xC4,0xF2,0x01,0x07,0x10,0x25,0x3D,0x70,0x40,0xF2,0x04,0x07,0xC4,0xF2,0x01,0x07,0x97,0xF9,0x00,0x60,0x10,0x25,0x75,0x40,0x05,0xB1,0xF5,0xE7,0x40,0xF2,0x14,0x07,0xC4,0xF2,0x01,0x07,0x40,0xF2,0x00,0x05,0x3D,0x60,0x40,0xF2,0x18,0x07,0xC4,0xF2,0x01,0x07,0x40,0xF2,0x80,0x05,0x3D,0x60,0x40,0xF2,0x1C,0x07,0xC4,0xF2,0x01,0x07,0x40,0xF2,0x80,0x05,0x3D,0x60,0x40,0xF2,0x00,0x07,0xC4,0xF2,0x01,0x07,0x50,0x25,0x3D,0x70,0x3A,0xE0,0x40,0xF2,0x38,0x07,0xC4,0xF2,0x01,0x07,0x3D,0x70,0x40,0xF2,0x3C,0x07,0xC4,0xF2,0x01,0x07,0x3E,0x70,0x40,0xF2,0x34,0x07,0xC4,0xF2,0x01,0x07,0x07,0x25,0x3D,0x70,0x40,0xF2,0x00,0x07,0xC4,0xF2,0x01,0x07,0x32,0x25,0x3D,0x70,0x40,0xF2,0x04,0x07,0xC4,0xF2,0x01,0x07,0x97,0xF9,0x00,0x60,0x32,0x25,0x75,0x40,0x05,0xB1,0xF5,0xE7,0x40,0xF2,0x14,0x07,0xC4,0xF2,0x01,0x07,0x40,0xF2,0x00,0x05,0x3D,0x60,0x40,0xF2,0x18,0x07,0xC4,0xF2,0x01,0x07,0x40,0xF2,0x80,0x05,0x3D,0x60,0x40,0xF2,0x1C,0x07,0xC4,0xF2,0x01,0x07,0x40,0xF2,0x80,0x05,0x3D,0x60,0x40,0xF2,0x00,0x07,0xC4,0xF2,0x01,0x07,0x52,0x25,0x3D,0x70,0x00,0xF0,0xCE,0xFA,0x3F,0xB1,0x85,0xF0,0xE8,0x05,0x25,0xB9,0x40,0xF2,0x31,0x01,0x00,0xF0,0xED,0xFA,0x04,0xE0,0x40,0xF2,0x32,0x01,0x00,0xF0,0xE8,0xFA,0xEF,0xE7,0x01,0x46,0x40,0xF2,0x05,0x02,0x00,0xF0,0xAB,0xFA,0x07,0xB9,0xF8,0xE7,0x01,0x78,0x81,0xF0,0x08,0x03,0x03,0xB9,0x1B,0xE0,0x81,0xF0,0x28,0x03,0x03,0xB9,0xB4,0xE0,0x81,0xF0,0x38,0x03,0x03,0xB9,0xDE,0xE0,0x81,0xF0,0x39,0x03,0x03,0xB9,0x44,0xE1,0x81,0xF0,0x3A,0x03,0x03,0xB9,0x7E,0xE1,0x81,0xF0,0x78,0x03,0x03,0xB9,0xB5,0xE1,0x81,0xF0,0x48,0x03,0x03,0xB9,0xC9,0xE1,0x32,0x21,0x00,0xF0,0xC0,0xFA,0xD7,0xE7,0x30,0x21,0x00,0xF0,0xBC,0xFA,0x00,0xF0,0xCA,0xFA,0x4F,0xEA,0x01,0x09,0x31,0x21,0x00,0xF0,0xB5,0xFA,0x01,0x46,0x40,0xF2,0x02,0x22,0x00,0xF0,0x79,0xFA,0x01,0x46,0x40,0xF2,0x00,0x22,0x00,0xF0,0xE4,0xFA,0x90,0xF8,0x00,0x12,0x4F,0xEA,0x01,0x21,0x90,0xF8,0x01,0x22,0x11,0x43,0x69,0x40,0x09,0xB1,0x35,0x21,0xDD,0xE7,0x30,0x21,0x00,0xF0,0x9D,0xFA,0x01,0x46,0x40,0xF2,0x80,0x02,0x4E,0x46,0x00,0xF0,0x22,0xFA,0x00,0xF0,0xD5,0xF9,0x00,0xF0,0x03,0xFA,0xC7,0xB3,0x02,0x31,0x02,0x36,0x00,0xF0,0xCE,0xF9,0x00,0xF0,0xFC,0xF9,0x8F,0xB3,0x02,0x31,0x02,0x36,0x42,0xF2,0x00,0x03,0xC0,0xF2,0x40,0x03,0xB3,0x42,0x02,0xD0,0x01,0x3A,0x02,0xB1,0xE6,0xE7,0x00,0xF0,0x28,0xFA,0x01,0x46,0x40,0xF2,0x80,0x02,0x4E,0x46,0x37,0x68,0x40,0xF2,0x08,0x07,0xC4,0xF2,0x00,0x07,0x3D,0x78,0x00,0x25,0x3D,0x70,0x33,0x68,0x0D,0x68,0x6B,0x40,0xEB,0xB9,0x40,0xF2,0x08,0x07,0xC4,0xF2,0x00,0x07,0x3D,0x78,0x05,0xF0,0x04,0x05,0xC5,0xB9,0x04,0x31,0x04,0x36,0x42,0xF2,0x00,0x03,0xC0,0xF2,0x40,0x03,0xB3,0x42,0x02,0xD0,0x01,0x3A,0x02,0xB1,0xE1,0xE7,0x31,0x21,0x96,0xE7,0x4F,0xF6,0xFF,0x72,0xCF,0xF6,0xFF,0x72,0x4F,0xF6,0xFF,0x73,0xCF,0xF6,0xFF,0x73,0x04,0xE0,0x0A,0x68,0x33,0x68,0x01,0xE0,0x0A,0x68,0x33,0x68,0x34,0x21,0x00,0xF0,0x48,0xFA,0x31,0x0E,0x00,0xF0,0x45,0xFA,0x31,0x0C,0x00,0xF0,0x42,0xFA,0x31,0x0A,0x00,0xF0,0x3F,0xFA,0x31,0x46,0x00,0xF0,0x3C,0xFA,0x11,0x0E,0x00,0xF0,0x39,0xFA,0x11,0x0C,0x00,0xF0,0x36,0xFA,0x11,0x0A,0x00,0xF0,0x33,0xFA,0x11,0x46,0x00,0xF0,0x30,0xFA,0x19,0x0E,0x00,0xF0,0x2D,0xFA,0x19,0x0C,0x00,0xF0,0x2A,0xFA,0x19,0x0A,0x00,0xF0,0x27,0xFA,0x19,0x46,0x00,0xF0,0x24,0xFA,0x34,0x21,0x5F,0xE7,0x30,0x21,0x00,0xF0,0x1F,0xFA,0x00,0xF0,0xC7,0xF9,0x00,0xF0,0x2B,0xFA,0x0B,0x46,0x0F,0x46,0x31,0x21,0x00,0xF0,0x16,0xFA,0x80,0x22,0x39,0x78,0x00,0xF0,0x12,0xFA,0x01,0x37,0x39,0x78,0x00,0xF0,0x0E,0xFA,0x01,0x37,0x39,0x78,0x00,0xF0,0x0A,0xFA,0x01,0x37,0x39,0x78,0x00,0xF0,0x06,0xFA,0x01,0x37,0x01,0x3A,0x02,0xB1,0xEC,0xE7,0x19,0x46,0x40,0xF2,0x00,0x22,0x00,0xF0,0x36,0xFA,0x4F,0xEA,0x15,0x21,0x00,0xF0,0xF9,0xF9,0x29,0x46,0x00,0xF0,0xF6,0xF9,0x31,0x21,0x31,0xE7,0x30,0x21,0x00,0xF0,0xF1,0xF9,0x00,0xF0,0xFF,0xF9,0x4F,0xEA,0x01,0x09,0x00,0xF0,0x76,0xF9,0x40,0xF6,0xA8,0x23,0xC2,0xF2,0x0C,0x03,0x40,0xF2,0xAA,0x05,0x1D,0x60,0x40,0xF2,0x54,0x53,0xC2,0xF2,0x0C,0x03,0x40,0xF2,0x55,0x05,0x1D,0x60,0x40,0xF6,0xA8,0x23,0xC2,0xF2,0x0C,0x03,0x40,0xF2,0x80,0x05,0x1D,0x60,0x40,0xF6,0xA8,0x23,0xC2,0xF2,0x0C,0x03,0x40,0xF2,0xAA,0x05,0x1D,0x60,0x40,0xF2,0x54,0x53,0xC2,0xF2,0x0C,0x03,0x40,0xF2,0x55,0x05,0x1D,0x60,0x40,0xF6,0xA8,0x23,0xC2,0xF2,0x0C,0x03,0x40,0xF2,0x10,0x05,0x1D,0x60,0x4F,0xF6,0xFF,0x75,0x40,0xF2,0x00,0x06,0xC2,0xF2,0x0C,0x06,0x00,0xF0,0x29,0xF9,0x0F,0xB9,0x00,0xF0,0x28,0xF8,0x40,0xF6,0xA8,0x23,0x40,0xF2,0xAA,0x05,0x1D,0x60,0x40,0xF2,0x54,0x53,0x40,0xF2,0x55,0x05,0x1D,0x60,0x40,0xF6,0xA8,0x23,0x40,0xF2,0x80,0x05,0x1D,0x60,0x40,0xF6,0xA8,0x23,0x40,0xF2,0xAA,0x05,0x1D,0x60,0x40,0xF2,0x54,0x53,0x40,0xF2,0x55,0x05,0x1D,0x60,0x40,0xF6,0xA8,0x23,0x40,0xF2,0x10,0x05,0x1D,0x60,0x4F,0xF6,0xFF,0x75,0x4E,0x46,0x00,0xF0,0x03,0xF9,0x1F,0xB1,0x00,0xF0,0x3A,0xF9,0x31,0x21,0xCB,0xE6,0x00,0xF0,0x36,0xF9,0x34,0x21,0xC7,0xE6,0x30,0x21,0x00,0xF0,0x87,0xF9,0x00,0xF0,0x2F,0xF9,0x42,0xF2,0x00,0x03,0xC0,0xF2,0x40,0x03,0x1D,0x68,0x4F,0xF2,0x00,0x23,0xC2,0xF2,0x03,0x03,0x1D,0x60,0x40,0xF2,0x00,0x13,0xC4,0xF2,0x00,0x03,0x1D,0x68,0x4F,0xF2,0x04,0x23,0xC2,0xF2,0x03,0x03,0x1D,0x60,0x4F,0xF2,0x00,0x23,0xC2,0xF2,0x03,0x03,0x19,0x78,0x00,0xF0,0x6A,0xF9,0x01,0x33,0x19,0x78,0x00,0xF0,0x66,0xF9,0x01,0x33,0x19,0x78,0x00,0xF0,0x62,0xF9,0x01,0x33,0x19,0x78,0x00,0xF0,0x5E,0xF9,0x01,0x33,0x19,0x78,0x00,0xF0,0x5A,0xF9,0x01,0x33,0x19,0x78,0x00,0xF0,0x56,0xF9,0x01,0x33,0x19,0x78,0x00,0xF0,0x52,0xF9,0x01,0x33,0x19,0x78,0x00,0xF0,0x4E,0xF9,0x31,0x21,0x89,0xE6,0x30,0x21,0x00,0xF0,0x49,0xF9,0x00,0xF0,0x57,0xF9,0x01,0x46,0x01,0x31,0x42,0xF2,0x00,0x06,0xC0,0xF2,0x40,0x06,0x00,0xF0,0xCA,0xF8,0x00,0xF0,0x7D,0xF8,0x00,0xF0,0xAB,0xF8,0x27,0xB3,0x02,0x31,0x02,0x36,0x00,0xF0,0x76,0xF8,0x00,0xF0,0xA4,0xF8,0xEF,0xB1,0x00,0xF0,0xDB,0xF8,0x01,0x46,0x01,0x31,0x42,0xF2,0x00,0x06,0xC0,0xF2,0x40,0x06,0x37,0x68,0x40,0xF2,0x08,0x07,0xC4,0xF2,0x00,0x07,0x3D,0x78,0x00,0x25,0x3D,0x70,0x33,0x68,0x0D,0x68,0x6B,0x40,0x4B,0xB9,0x40,0xF2,0x08,0x07,0xC4,0xF2,0x00,0x07,0x3D,0x78,0x05,0xF0,0x04,0x05,0x0D,0xB9,0x31,0x21,0x52,0xE6,0x00,0xF0,0xBD,0xF8,0x34,0x21,0x4E,0xE6,0x30,0x21,0x00,0xF0,0x0E,0xF9,0x31,0x21,0x00,0xF0,0x0B,0xF9,0x48,0xF2,0x05,0x0B,0xC4,0xF2,0x03,0x0B,0x9B,0xF8,0x00,0xC0,0x1C,0xF0,0x01,0x0C,0xF6,0xD0,0x40,0xF2,0x04,0x01,0xC0,0xF2,0x00,0x01,0x4E,0xF6,0x0C,0x53,0xCE,0xF2,0x00,0x03,0x19,0x60,0x30,0x21,0x00,0xF0,0xF6,0xF8,0x01,0x46,0x05,0x31,0x40,0xF2,0x04,0x02,0x00,0xF0,0xB9,0xF8,0x00,0xF0,0x0C,0xF9,0x00,0xF0,0x96,0xF8,0x4F,0xF6,0xFF,0x72,0xCF,0xF6,0xFF,0x72,0x1D,0x68,0x2E,0x46,0x55,0x40,0x35,0xB9,0x04,0x33,0x1F,0x46,0x8F,0x42,0x00,0xD2,0xF6,0xE7,0x31,0x21,0x1A,0xE6,0x34,0x21,0x00,0xF0,0xDA,0xF8,0x19,0x0E,0x00,0xF0,0xD7,0xF8,0x19,0x0C,0x00,0xF0,0xD4,0xF8,0x19,0x0A,0x00,0xF0,0xD1,0xF8,0x19,0x46,0x00,0xF0,0xCE,0xF8,0x31,0x0E,0x00,0xF0,0xCB,0xF8,0x31,0x0C,0x00,0xF0,0xC8,0xF8,0x31,0x0A,0x00,0xF0,0xC5,0xF8,0x31,0x46,0x00,0xF0,0xC2,0xF8,0x34,0x21,0xFD,0xE5,0x40,0xF2,0x00,0x03,0xC2,0xF2,0x00,0x03,0x33,0x40,0xBB,0xB1,0x40,0xF2,0xAA,0x05,0x40,0xF6,0xA8,0x23,0xC2,0xF2,0x0C,0x03,0x1D,0x60,0x40,0xF2,0x54,0x53,0xC2,0xF2,0x0C,0x03,0x40,0xF2,0x55,0x05,0x1D,0x60,0x40,0xF6,0xA8,0x23,0xC2,0xF2,0x0C,0x03,0x40,0xF2,0xA0,0x05,0x1D,0x60,0x0D,0x88,0x35,0x80,0x10,0xE0,0x40,0xF2,0xAA,0x05,0x40,0xF6,0xA8,0x23,0x1D,0x60,0x40,0xF2,0x54,0x53,0x40,0xF2,0x55,0x05,0x1D,0x60,0x40,0xF6,0xA8,0x23,0x40,0xF2,0xA0,0x05,0x1D,0x60,0x0D,0x88,0x35,0x80,0xF7,0x46,0x33,0x88,0x33,0x88,0x4F,0xEA,0x03,0x0A,0x40,0xF2,0x80,0x07,0x3B,0x40,0x2F,0x40,0x5F,0x40,0x77,0xB1,0x53,0x46,0x40,0xF2,0x20,0x07,0x1F,0x40,0x07,0xB9,0xF0,0xE7,0x33,0x88,0x40,0xF2,0x80,0x07,0x3B,0x40,0x2F,0x40,0x5F,0x40,0x0F,0xB1,0x00,0x27,0xF7,0x46,0x01,0x27,0xF7,0x46,0x40,0xF2,0x08,0x07,0xC4,0xF2,0x00,0x07,0x3D,0x78,0x05,0xF0,0x01,0x05,0x05,0xB9,0xF6,0xE7,0x40,0xF2,0x00,0x07,0xC4,0xF2,0x00,0x07,0x01,0x25,0x3D,0x70,0x40,0xF2,0x08,0x07,0xC2,0xF2,0x0E,0x07,0x3D,0x78,0x05,0xF0,0x01,0x05,0x05,0xB9,0xF6,0xE7,0x40,0xF2,0x00,0x07,0xC2,0xF2,0x0E,0x07,0x00,0x25,0x3D,0x70,0xF7,0x46,0x40,0xF2,0x08,0x07,0xC4,0xF2,0x00,0x07,0x3D,0x78,0x05,0xF0,0x01,0x05,0x05,0xB9,0xF6,0xE7,0x40,0xF2,0x00,0x07,0xC4,0xF2,0x00,0x07,0x02,0x25,0x3D,0x70,0x40,0xF2,0x08,0x07,0xC2,0xF2,0x0E,0x07,0x3D,0x78,0x05,0xF0,0x01,0x05,0x05,0xB9,0xF6,0xE7,0x40,0xF2,0x00,0x07,0xC2,0xF2,0x0E,0x07,0x01,0x25,0x3D,0x70,0xF7,0x46,0x74,0x46,0x00,0xF0,0x0D,0xF8,0x37,0xB1,0x0D,0x70,0x01,0x31,0x01,0x3A,0x02,0xB1,0xF7,0xE7,0x01,0x27,0xA7,0x46,0x32,0x21,0x00,0xF0,0x29,0xF8,0x00,0x27,0xA7,0x46,0x48,0xF2,0x05,0x03,0xC4,0xF2,0x03,0x03,0x93,0xF8,0x00,0x70,0x07,0xF0,0x38,0x07,0x8F,0xB9,0x48,0xF2,0x05,0x03,0xC4,0xF2,0x03,0x03,0x93,0xF8,0x00,0x70,0x07,0xF0,0x04,0x07,0x07,0xB9,0xEC,0xE7,0x48,0xF2,0x08,0x03,0xC4,0xF2,0x03,0x03,0x93,0xF8,0x00,0x50,0x01,0x27,0xF7,0x46,0x48,0xF2,0x05,0x03,0xC4,0xF2,0x03,0x03,0x93,0xF8,0x00,0x70,0x47,0xF0,0x80,0x07,0x1F,0x70,0x4F,0xF0,0x00,0x07,0xF7,0x46,0x48,0xF2,0x05,0x0B,0xC4,0xF2,0x03,0x0B,0x9B,0xF8,0x00,0xC0,0x1C,0xF0,0x01,0x0C,0xF6,0xD0,0x48,0xF2,0x08,0x0C,0xC4,0xF2,0x03,0x0C,0x8C,0xF8,0x00,0x10,0xF7,0x46,0x01,0x79,0x4F,0xEA,0x01,0x61,0xC6,0x78,0x4F,0xEA,0x06,0x46,0x31,0x43,0x86,0x78,0x4F,0xEA,0x06,0x26,0x31,0x43,0x46,0x78,0x31,0x43,0xF7,0x46,0x01,0x7A,0x4F,0xEA,0x01,0x61,0xC6,0x79,0x4F,0xEA,0x06,0x46,0x31,0x43,0x86,0x79,0x4F,0xEA,0x06,0x26,0x31,0x43,0x46,0x79,0x31,0x43,0x03,0x79,0x4F,0xEA,0x03,0x63,0xC6,0x78,0x4F,0xEA,0x06,0x46,0x33,0x43,0x86,0x78,0x4F,0xEA,0x06,0x26,0x33,0x43,0x46,0x78,0x33,0x43,0xF7,0x46,0x40,0xF2,0x00,0x05,0x40,0xF2,0x00,0x03,0xC1,0xF2,0x21,0x03,0x0F,0x78,0x01,0x31,0x3F,0x06,0x6F,0x40,0x7F,0x00,0x00,0xD3,0x5F,0x40,0x7F,0x00,0x00,0xD3,0x5F,0x40,0x7F,0x00,0x00,0xD3,0x5F,0x40,0x7F,0x00,0x00,0xD3,0x5F,0x40,0x7F,0x00,0x00,0xD3,0x5F,0x40,0x7F,0x00,0x00,0xD3,0x5F,0x40,0x7F,0x00,0x00,0xD3,0x5F,0x40,0x7F,0x00,0x00,0xD3,0x5F,0x40,0x3D,0x46,0x01,0x3A,0x02,0xB1,0xDF,0xE7,0x2D,0x0C,0xF7,0x46,0x00,0x00,0x4D,0x42,0x39,0x42,0x35,0x36,0x34,0x4B,0x20,0x52,0x65,0x76,0x31,0x2E,0x31,0x39,0xB3};
UCHAR jump_to_ram[]={0xC0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0};
UCHAR erase_cr_data_read[]={0x39, 0x00, 0x00, 0x00, 0x00};
UCHAR cr_trimming_mirror_data[]={0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,};
UCHAR chip_erase[]={0x38, 0xFF, 0xFF, 0x03, 0x00};
UCHAR blank_check_0[]={0x48, 0x00, 0x00, 0x00, 0x00};
UCHAR blank_check_1[]={0xFF, 0xFF, 0x03, 0x00};

static void _write_data(int *pCondNo, UCHAR *data, int size, char response, int tio);
static void _read_block(int *pCondNo, int tio);
static void _set_out(int data);
static void _set_state(EnDownloadState state, int condNo);

static void _send_ram_kernel(int *pCondNo);
static void _read_last_block(int *pCondNo);
static void _read_user_flash(int *pCondNo);
static void _write_user_flash(int *pCondNo);
static void _erase_and_check(int *pCondNo);
static void _program_flash	(int *pCondNo);

static SConditionerData _Cond[MAX_HEADS_BOARD];
static SFlashData		_ProgramData;
static int				_Running=0;

//--- bootloader_running ------------------
int	bootloader_running(void)
{
	return _Running!=0;
}

//--- bootloader_start ---------------------------------
void bootloader_start(void)
{
	int		condNo   = 0x0f;
	int  	*pCondNo = &condNo;
	int 	i;
	UCHAR data_out;

	pRX_Status->condDnlBlkAddr = pRX_Config->exe.blkAddr;

	_Running = TRUE;
	_set_state(dnl_start, condNo);

#ifdef TRACE
	trprintf("Download Conditioner[%d]\n", condNo);
#endif

//	pRX_Config->cond[condNo].backup_pump_minutes = pRX_Status->cond[condNo].pump_minutes;

	_send_ram_kernel(&condNo);
	if (!condNo) goto restart;

	#ifdef TRACE
		trprintf("Set Baudrate to 115200\n");
	#endif

	FOR_ALL_COND uart_set_baudrate(i, divisor_115200_baud);

	timer_sleep(100);
	#ifdef TRACE
		trprintf("start_bootloader 3: send 0xe8\n");
	#endif
	{
		int no;
		for (i=0; i<10; i++)
		{
			#ifdef TRACE
				trprintf("%d: _send 0x18\n", timer_getTick());
			#endif
			data_out = 0xE8;
			no = *pCondNo;
			_write_data(&condNo, &data_out, 1, 0x31, 100);
			if (no==*pCondNo) break;
		}
	}
	if (!condNo) goto restart;

	timer_sleep(200);

	FOR_ALL_COND memset(&_Cond[i].data, 0, sizeof(_Cond[i].data));

	_read_last_block(&condNo);
	if (!condNo) goto restart;

	FOR_ALL_ACTIVE_COND
	{
		/*
		int n;
		for (n=0; n<512; n++)
		{
			printf("%03d:  %02x/%c  %02x/%c\n", n, pRX_Config->exe.blkData[n], pRX_Config->exe.blkData[n], _Cond[i].data.data[n], _Cond[i].data.data[n]);
		}
		printf("addr=0x%04x 0x%04x memcmp=%d\n",  pRX_Config->exe.blkAddr, pRX_Status->condDnlBlkAddr, memcmp(_Cond[i].data.data, pRX_Config->exe.blkData, FLASH_BLK_SIZE));
		*/
		if (!memcmp(_Cond[i].data.data, pRX_Config->exe.blkData, FLASH_BLK_SIZE))
		{
			#ifdef TRACE
				trprintf("Conditioner[%d] up to date\n", i);
			#endif
			condNo &= ~(1<<i);
		}
	}
	if (!condNo) goto restart;

	_read_user_flash(&condNo);
	_erase_and_check(&condNo);
	_program_flash(&condNo);
	_write_user_flash(&condNo);

restart:
	//--- restart ---------------------------
	condNo = 0x0f;
	_set_state(dnl_mcu_reset2, condNo);

//	_set_out(MCU_BOOTLOADER | MCU_RESET);	// active now
	main_rebooting_cond();
	_set_out(MCU_BOOTLOADER);              	//reserve=0, oe_bootloader=1; boot_uc=0, reset=0	//reset uc
	timer_sleep(200);
	_set_out(MCU_BOOTLOADER | MCU_RESET);
	_set_out(                 MCU_RESET);

	timer_sleep(100);

	//--- restart uart ----------------------------
	FOR_ALL_COND uart_set_baudrate(i, divisor_115200_baud);

	_set_state(dnl_done, condNo);
	_Running = FALSE;
	#ifdef TRACE
		trprintf("bootloader END\n");
	#endif
}

//--- _send_ram_kernel -----------------------------------------------
static void _send_ram_kernel (int *pCondNo)
{
	int 	i;
	UCHAR	data_out;

	_set_state(dnl_reset, *pCondNo);
	#ifdef TRACE
		trprintf("dnl_reset\n");
	#endif

//	_set_out(MCU_BOOTLOADER);
//	_set_out(MCU_BOOTLOADER); // | 			 MCU_RESET);
//	_set_out(MCU_BOOTLOADER | MCU_BOOT | MCU_RESET);

	_set_out(MCU_BOOTLOADER | MCU_BOOT 			 );
	timer_sleep(500);
	_set_out(MCU_BOOTLOADER | MCU_BOOT | MCU_RESET);
	timer_sleep(100);

	FOR_ALL_COND uart_set_baudrate(i, divisor_9600_baud);
	timer_sleep(100);

	int condNo;
	for (i=0; i<10; i++)
	{
		#ifdef TRACE
			trprintf("%d: _send 0x18\n", timer_getTick());
		#endif
		data_out = 0x18;
		condNo = *pCondNo;
		_write_data(&condNo, &data_out, 1, 0x11, 100);
		if (condNo==*pCondNo) break;
	}

	if (condNo==0) return;

	_set_state(dnl_send_ram_kernel, *pCondNo);

	#ifdef TRACE
		trprintf("dnl_send_ram_kernel prepare\n");
	#endif

	_write_data(pCondNo, ram_kernel_prepare, sizeof(ram_kernel_prepare), 0x01, 2000);

	#ifdef TRACE
		trprintf("dnl_send_ram_kernel\n");
	#endif
	_write_data(pCondNo, ram_kernel, sizeof(ram_kernel), 0x01, 1000);

	if (*pCondNo==0) return;

	_set_state(dnl_start_ram_kernel, *pCondNo);
	#ifdef TRACE
		trprintf("send 0x18\n");
	#endif
	for (i=0; i<10; i++)
	{
		#ifdef TRACE
			trprintf("%d: _send 0x18\n", timer_getTick());
		#endif
		data_out = 0x18;
		condNo = *pCondNo;
		_write_data(&condNo, &data_out, 1, 0x11, 100);
		if (condNo==*pCondNo) break;
	}
	if (*pCondNo==0) return;

	#ifdef TRACE
		trprintf("jump_to_ram\n");
	#endif
	_write_data(pCondNo, jump_to_ram, sizeof(jump_to_ram), 0x31, 2000);
}

//--- _erase_and_check --------------------------------
static void _erase_and_check(int *pCondNo)
{
	_set_state(dnl_chip_erase, *pCondNo);
	_write_data(pCondNo, chip_erase, sizeof(chip_erase), 0x31, 20000);
	
	_set_state(dnl_blank_check, *pCondNo);
	_write_data(pCondNo, blank_check_0, sizeof(blank_check_0), 0x30, 2000);
	_write_data(pCondNo, blank_check_1, sizeof(blank_check_1), 0x31, 2000);
}

//--- _read_last_block -------------------------------------------
static void _read_last_block(int *pCondNo)
{
	SFlashCmd  cmd;

	#ifdef TRACE
		trprintf("READ Last Flash Block\n");
	#endif

	cmd.cmd	 = 0x28;	// read command
	cmd.addr = pRX_Config->exe.blkAddr;
	_write_data(pCondNo, (UCHAR*)&cmd, sizeof(cmd), 0x31, 500);
	_read_block(pCondNo, 200);
}

//--- _read_user_flash --------------------------
static void _read_user_flash(int *pCondNo)
{
	SFlashCmd  cmd;

	#ifdef TRACE
		trprintf("Read User Flash\n");
	#endif
	cmd.cmd	 = 0x28;	// read command
	cmd.addr = CONDITIONER_FLASH_USER_ADDR;
	_write_data(pCondNo, (UCHAR*)&cmd, sizeof(cmd), 0x31, 500);
	_read_block(pCondNo, 200);
}

//--- _write_user_flash -------
static void _write_user_flash(int *pCondNo)
{
	int i, n;
	SFlashCmd  cmd;

	#ifdef TRACE
		trprintf("Write User Flash\n");
	#endif

	for (i=0; i<MAX_HEADS_BOARD; i++)
	{
		if (*pCondNo && (1<<i))
		{
			cmd.cmd  = 0x08; // write command
			cmd.addr = CONDITIONER_FLASH_USER_ADDR;
			n = 1<<i;
			_write_data(&n, (UCHAR*)&cmd, sizeof(cmd), 0x31, 200);
			_write_data(&n, (UCHAR*)&_Cond[i].data, sizeof(_Cond[i].data), 0x31, 500);
		}
	}
}

//--- _program_flash ----------------------------------------------
static void _program_flash(int *pCondNo)
{
	int end;
	SFlashCmd  cmd;
	unsigned short crc;

	_set_state(dnl_write_binary, *pCondNo);

	cmd.cmd  = 0x08; // write command
	pRX_Status->condDnlBlkAddr = 0;

	for(cmd.addr=0; cmd.addr<pRX_Config->exe.size; cmd.addr+=FLASH_BLK_SIZE)
	{
		end = timer_getTick()+500;
		while (pRX_Config->exe.blkAddr!=cmd.addr)
		{
			if (timer_getTick()>end)
			{
				int i;
				for(i=0; i<MAX_HEADS_BOARD; i++)
				{
					#ifdef TRACE
						trprintf("%d: cond[%d]: timeout\n", timer_getTick(), 0);
					#endif
					pRX_Status->cond[i].error |= COND_ERR_download;
					*pCondNo &= ~(1<<i);
				}
				return;
			}
			timer_sleep(1);
		}
		memcpy(_ProgramData.data, &pRX_Config->exe.blkData, FLASH_BLK_SIZE);
		pRX_Status->condDnlBlkAddr += FLASH_BLK_SIZE;
		crc=crc_calc((char*)_ProgramData.data, FLASH_BLK_SIZE);
		_ProgramData.crc_low  = (crc&0xff);
		_ProgramData.crc_high = (crc&0xff00)>>8;

		#ifdef TRACE
			trprintf("program_flash: Addr=%d, crc=0x%04x\n", cmd.addr, crc);
		#endif
		_write_data(pCondNo, (UCHAR*)&cmd, sizeof(cmd), 0x31, 200);

		#ifdef TRACE
			trprintf("program_flash: Write Data\n");
		#endif
		_write_data(pCondNo, (UCHAR*)&_ProgramData, sizeof(_ProgramData), 0x31, 500);
	}
}

//--- _write_data --------------------------------------
static void _write_data(int *pCondNo, UCHAR *data, int size, char response, int tio)
{
	int done=0;
	int i, n;
	int end;
	UCHAR data_in;

	FOR_ALL_ACTIVE_COND
	{
		for(n=0; n<size; n++)
		{
			while (!uart_write_byte(i, data[n]));
		}
	}

	FOR_ALL_ACTIVE_COND
	{
		uart_wait_sent(i);
	}
	timer_sleep(10);
	end = timer_getTick()+tio;

	while(done!=*pCondNo)
	{
		for(i=0; i<MAX_HEADS_BOARD; i++)
		{
			if ((*pCondNo&(1<<i))&& !(done&(1<<i)))
			{
				if (timer_getTick()>end)
				{
					#ifdef TRACE
						trprintf("%d: cond[%d]: timeout\n", timer_getTick(), i);
					#endif
					pRX_Status->cond[i].error |= COND_ERR_download;
					*pCondNo &= ~(1<<i);
				}
				else if (uart_read(i, &data_in))
				{
					#ifdef TRACE
						trprintf("cond[%d]: data_in =0x%x\n", i, data_in);
					#endif

					if (data_in==response)
					{
						#ifdef TRACE
							trprintf("cond[%d]: OK\n", i);
						#endif
						done |= (1<<i);
					}
					else
					{
						switch (data_in)
						{
						case 0x30:	break;	// busy
						case 0x31:
									#ifdef TRACE
										trprintf("cond[%d]: OK\n", i);
									#endif
									done |= (1<<i);
									break;

						case 0x32:
									#ifdef TRACE
										trprintf("cond[%d]: ERROR blank check\n", i);
									#endif
										pRX_Status->cond[i].error |= COND_ERR_download;
									*pCondNo &= ~(1<<i);
									break;

						case 0x34:
									#ifdef TRACE
										trprintf("cond[%d]: ERROR write\n", i);
									#endif
										pRX_Status->cond[i].error |= COND_ERR_download;
									*pCondNo &= ~(1<<i);
									break;

						case 0x35:
									#ifdef TRACE
										trprintf("cond[%d]: ERROR crc\n", i);
									#endif
										pRX_Status->cond[i].error |= COND_ERR_download;
									*pCondNo &= ~(1<<i);
									break;
						}
					}
				}
			}
		}
	}
}

//--- _read_block --------------------------------------
static void _read_block(int *pCondNo, int tio)
{
	int done=0;
	int i;
	int end;
	UCHAR data_in;

	end = timer_getTick()+tio;

	for (i=0; i<MAX_HEADS_BOARD; i++) _Cond[i].pos=0;

	//--- read back data block --------------------
	while(done!=*pCondNo)
	{
		for(i=0; i<MAX_HEADS_BOARD; i++)
		{
			if ((*pCondNo&(1<<i)) && !(done&(1<<i)))
			{
				if (timer_getTick()>end)
				{
					#ifdef TRACE
						trprintf("%d: cond[%d].TIMEOUT: Received %d bytes\n", timer_getTick(), i, _Cond[i].pos);
					#endif
					pRX_Status->cond[i].error |= COND_ERR_download;
					*pCondNo &= ~(1<<i);
				}
				else if (uart_read(i, &data_in))
				{
					_Cond[i].data.data[_Cond[i].pos] = data_in;
					if (++_Cond[i].pos>FLASH_BLK_SIZE+2)
					{
						#ifdef TRACE
							trprintf("cond[%d]: Received %d Bytes\n", i, _Cond[i].pos);
						#endif
						done |= (1<<i);
					}
				}
			}
		}
	}
}

//--- _set_out -------------------------------
static void _set_out(int data)
{
	int condNo;

	static int 	_pio_base[4]={COND_PIO_0_BASE, COND_PIO_1_BASE, COND_PIO_2_BASE, COND_PIO_3_BASE};
	for (condNo=0; condNo<MAX_HEADS_BOARD; condNo++)
	{
		IOWR_ALTERA_AVALON_PIO_DATA(_pio_base[condNo], data);
	}
}

//--- _set_state ----------------------------------------------------
static void _set_state(EnDownloadState state, int condNo)
{
	pRX_Status->condDnlState = state;
	pRX_Status->condDnlNo    = condNo;

	#ifdef TRACE
		trprintf("cond[%01x]: %s\n", condNo, DownloadStateStr(state));
	#endif
}

